---
title: "<center> <h1>Assignment 5</h1> </center>"
author:
- name: Mubarak Mojoyinola and Geraldo Padilla
  affiliation: The University of Iowa
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    theme: simplex
    highlight: textmate
subtitle: <center> <h1>User Created Functions and Bootstrap</h1> </center>
---

<style type="text/css">
body{
  font-family: Arial;
  font-size: 12pt;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(include = F)
```

```{r packages}
library(tidyverse)
library(palmerpenguins)
library(ggformula)
library(patchwork)
```

```{r data}
penguins <- penguins %>%
  mutate(penguin_id = 1:n())
```

## Questions

1. Create a function that generates a random sample, with replacement, from the original data, penguins from the palmerpenguins package. 

```{r bootstrap, include=TRUE}
resample_penguins <- function(data) {
  slice_sample(data, n = nrow(data), replace = TRUE)
}
```

```{r head_boots, include=TRUE, echo=FALSE}
head(resample_penguins(penguins))
```

2. From a single bootstrap (i.e., using your function from #1), verify that the sampling with replacement is occurring. Use the penguin_id attribute created from the code used prior to starting the assignment to show that sampling with replacement is working properly. What would you expect if sampling with replacement is working?

If sampling with replacement works, thus we should observe more than one ID repeated in the new sample.

```{r graph_rep, include = T, echo=FALSE}
resample_penguins(penguins) %>% 
  count(penguin_id) %>%
  gf_col(n ~ penguin_id)%>%
  gf_labs(
    title = "Resampling penguins ID",
    #subtitle = "(at baseline)",
    #color = "Abused substance: ",
    x = "Penguin ID",
    y = "Repetitions",
    #caption = "Source: HELPrct"
    )%>%
  gf_theme(theme_classic()) %>%
  gf_theme(
    #axis.text.y = element_blank(),
    #legend.position = "top",
    plot.title = element_text(hjust = 0.5, color = "navy"),
    #plot.subtitle = element_text(hjust = 0.5, color = "navy", size = 12)
  )
```

3. Given the function created in #1, letâ€™s add a function argument to the function. Add a function argument that allows users to control whether sampling with replacement or without replacement is performed.

```{r repl, include=TRUE}
resample_penguins <- function(data, repl = TRUE) {
  
  slice_sample(data, n = nrow(data), replace = repl)
}
```

4. Verify that the function argument created in #3 is working properly by running the function specifying the argument to do the sampling with and without replacement. What difference in the output helps to show that the function argument is working properly?

The graphs below show the difference between replacement and non-replacement. The first one works by including more than one ID, which means that some penguins are sampled multiple times in the new sample. On the other hand, the second graph shows that each ID is selected only once in the new sample, as `repl` has been disabled.

```{r graphs_repl, include=TRUE, echo=FALSE, results='hold'}
resample_penguins(penguins, repl = T) %>% 
  count(penguin_id) %>%
  gf_col(n ~ penguin_id)%>%
  gf_labs(
    title = "Resampling penguins ID",
    x = "Penguin ID",
    y = "Repetitions")%>%
  gf_theme(theme_classic()) %>%
  gf_theme(
    plot.title = element_text(hjust = 0.5, color = "navy"))

resample_penguins(penguins, repl = F) %>% 
  count(penguin_id) %>%
  gf_col(n ~ penguin_id)%>%
  gf_labs(
    title = "Resampling penguins ID",
    x = "Penguin ID",
    y = "Repetitions")%>%
  gf_theme(theme_classic()) %>%
  gf_theme(
    plot.title = element_text(hjust = 0.5, color = "navy"))
```

5. Add an argument that follows branching logic to implement different statistics to be computed to fulfill step #3 of the bootstrap procedure.

```{r stats, include = T}
resample_penguins <- function(data, variable, repl = TRUE,
                              stat = c('mean', 'sd', 'median', 'quantile')) {
  
  data_resample <- data.frame(slice_sample(data, n = nrow(data), replace = repl))
  
  if(stat == 'mean') {
    mean(data_resample[[variable]], na.rm = T)
  } else if(stat == 'sd') {
    sd(data_resample[[variable]], na.rm = TRUE)
  } else if(stat == 'median') {
    median(data_resample[[variable]], na.rm = TRUE)
  } else {
    quantile(data_resample[[variable]], na.rm = TRUE)
  }
}
```

6. Verify that the branching rlogic and different statistics are working properly from step #5. Run the function for each branch of the function to confirm that different statistics are being computed.

```{r stat_mean, include = T}
resample_penguins(penguins, variable = "body_mass_g", stat = "mean")
```


```{r stat_2, include = T}
resample_penguins(penguins, variable = "body_mass_g", stat = "sd")
```


```{r stat_3, include = T}
resample_penguins(penguins, variable = "body_mass_g", stat = "median")
```


```{r stat_4, include = T}
resample_penguins(penguins, variable = "body_mass_g", stat = "quantile")
```

7. Replicate the bootstrap procedure many times. Pick two different number of bootstrap replications and save those two objects.

```{r replications, include = T}
rep1 <- data.frame(map_dbl(1:2000, resample_penguins, data = penguins, variable = "body_mass_g", stat = "mean"))

rep2 <- data.frame(map_dbl(1:4000, resample_penguins, data = penguins, variable = "body_mass_g", stat = "mean"))
```

```{r names}
colnames(rep1) <- 'means'
colnames(rep2) <- 'means'
```

8. Visualize the bootstrap results for both number of bootstrap replications chosen in #7. 
8.1 Are there any differences in the two distributions based on the different number of replications chosen? 

There are not many differences in this scenario. We have used `coord_cartesian` to visualize a similar body mass metric, but due to the sample size selected, both distributions are very similar. Both distributions range around a mean equal to 4,200.

8.2 Why may these differences be showing up?

The few differences are due to sample size and bootstrap replacement. As the sample size increases, the distribution becomes bell-shaped. On the other hand, the mean counts vary due to bootstrap replacement and may approach a normal distribution as the number of cases increases. Without this condition, the plots would be the same.

8.3 Which number of replications would be more defensible in your opinion?

In this example we use 4,000 replicates and the distribution looks very normal. We would not increase the sample size for efficiency. However, if the results were not clear, perhaps 6,000 or 10,000 replicates would be better. With today's computing power, that is not a problem.

```{r plotting_means, include=TRUE, echo=FALSE}
p1 <- ggplot(rep1, aes(means))+
  geom_histogram(fill = 'blue', color = 'white', binwidth = 5) +
  labs(title = 'Bootstrap results: penguin body mass averages',
       x = NULL, y = 'Count')+
  geom_text(aes(x = 4100, y = 60, label = "n = 2.000"), vjust = "inward", hjust = "inward", color = "blue")+
  theme_bw()+
  coord_cartesian(xlim = c(4065,4340))

p2 <- ggplot(rep2, aes(means))+
  geom_histogram(fill = 'red', color = 'white', binwidth = 5) +
  labs(x = 'Means (grams)', y = 'Count')+
  geom_text(aes(x = 4100, y = 120, label = "n = 4.000"), vjust = "inward", hjust = "inward", color = "red")+
  theme_bw()+
  coord_cartesian(xlim = c(4065,4340))

p1/p2
```